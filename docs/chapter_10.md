### 챕터 10. 클러스터간 데이터 미러링 하기

이 책에서는 주로 단일 카프카 클러스터를 설치하고, 운영하고, 사용하는 방법에 대해서 설명하였다. (실무에서도 단일 카프카 클러스터를 사용하고 있음)

하지만 하나 이상의 클러스터로 구성되는 아키텍처가 필요한 경우가 있다.

> 2개 이상의 클러스터가 서로 완전히 분리되어 있는 경우
- 각 클러스터가 다른 용도로 사용되기 때문에 한쪽에 있는 데이터를 다른 쪽으로 복사할 이유가 없는 경우이다.
- 이러한 사례는 꽤 쉬운데, 여러 개의 별도 클러스터를 운영하는 것은 단일 클러스터를 여러 개 운영하는 것과 같은 것이다.

> 운영자가 상호 의존하는 클러스터 사이에 데이터를 지속적으로 복사해 줘야 하는 경우
- 클러스터에 속한 카프카 노드 간의 데이터의 교환을 복제라고 부르고 있으므로, 카프카 클러스터 간의 데이터 복제는 '미러링' 이라고 부를 것이다.
- 아파치 카프카에는 클러스터간 데이터 복제를 수행하기 위한 툴로 '미러메이커' 를 포함하고 있다.

### 10.1 클러스터간 미러링 활용 사례

다음 사례들은 클러스터간 미러링이 활용될 수 있는 사례들이다.

#### 지역 및 중앙 클러스터 

- 하나의 기업이 지리적으로 분산된 지역, 도시, 대륙 간에 하나 이상의 데이터센터를 가지고 있을 수 있으며, 각각의 데이터센터에 카프카 클러스터가 설치되어 있는 경우다.
- 예를 들어 한 회사는 사무실을 운영중인 각각의 도시에 데이터 센터를 가지고 각 지역의 수요와 공급에 대한 정보를 수집해서 그에 따라 가격을 조정한다.
- 이 모든 데이터는 그 후 중앙 클러스터로 미러링되어 비즈니스 분석가들이 회사 단위의 수익 보고를 할 때 사용할 수 있다.

#### 고가용성 & 재해 복구

- 전체 클러스터가 어떠한 이유에서든 사용 불가능하게 될 가능성은 우려스럽다. 
- 첫번째 클러스터의 모든 데이터를 보유하는 여분의 두 번째 클러스터를 준비해 뒀다가 만약의 사태가 발생했을 때, 
- 애플리케이션을 두 번째 클러스터를 사용해서 작동하도록 함으로써 평상시처럼 작업을 계속하게 할 수 있다.

#### 규제

- 국가별로 다른 법적, 규제적 요구 조건을 따르기 위해 나라마다 있는 카프카 클러스터별로 서로 다른 설정과 정책을 시행해야 할 수 있다.
- 예를 들어서, 어떠한 데이터는 엄격한 접근 설정과 함께 서로 분리된 클러스터에 저장한 뒤 그 중 일부는 보다 개방적인 접근 설정이 되어 있는 클러스터로 복제하는 식이다.

#### 클라우드 마이그레이션

- 요즘은 각각의 온프레미스 데이터센터와 각각의 클라우드 리전에 최소 1개의 카프카 클러스터가 존재하는 것이 보통이다.
- 이러한 카프카 클러스터들은 데이터센터 간에 데이터를 효율적으로 전송하기 위해 각각의 데이터센터나 리전에 위치한 어플리케이션에 의해 사용된다.
- 예를 들어서, 클라우드 환경에서 온프레미스 데이터베이스에 저장되는 데이터를 필요로 한다거나 할 경우, 카프카 커넥트를 사용해서 데이터베이스의 변경 내역을 로컬 카프카 클러스터로 내보낸 뒤 이를 다시 클라우드 환경에서 실행되는 카프카 클러스터로 미러링함으로써 클라우드 환경에서도 이 데이터를 사용할 수 있도록 할 수 있다.
- 이러한 방식은 데이터 센터 간의 트래픽을 관리하고 보안을 유지하는 데 도움을 줄 뿐만 아니라 비용 역시 절감할 수 있게 해 준다.

#### 엣지 클러스터로부터의 데이터 집적 ( : 모아 쌓는 것 )

- 유통, 통신, 물류에서 헬스케어에 이르는 여러 산업에서는 연결성이 제한된 소형 기기를 사용해서 데이터를 생성한다.
- 가용성이 높은 집적용 클러스터를 사용한다면 많은 수의 엣지 클러스터로부터 수집된 데이터를 분석하는 등의 용도로 사용될 수 있다.
- 엣지 클러스터 란?
- 네트워크의 클라이언트 또는 디바이스에게 컴퓨팅 파워를 분산해주는 기술 구조
- 중앙 집중형 Cloud는 대용량/고성능 처리가 필요한 워크로드에 집중하고, Edge 에서는 초저지연/초연결이 필요한 워크로드를 수행하면서 상호 보완적 모델을 구현한다.
- 참고 : https://tech.ktcloud.com/48

- 가용성이 높은 집적용 클러스터는 엣지 클러스터가 오프라인 상태가 되거나 할 경우에도 연속적으로 작업을 수행할 수 있게 해줄 뿐 아니라 불안정한 네트워크로 연결되어 있는 많은 수의 엣지 클러스터를 직접적으로 신경 쓸 필요가 없도록 한다.

### 10.2 다중 클러스터 아키텍처

위 활용 사례를 구현할 때 성공적으로 사용되어 온 공통적인 아키텍처 패턴들을 살펴보자.

아키텍처를 살펴보기 전에 데이터센터 간 통신에서 현실적으로 고려해야 할 사항들에 대해서 간략히 살펴보자.

#### 10.2.1 데이터센터간 통신의 현실적 문제들

#### 높은 지연

- 두 카프카 클러스터 간의 거리나 네트워크 홉 개수가 증가함에 따라 통신 지연 역시 증가한다.

#### 제한된 대역폭

- 광역 통신망은 일반적으로 단일 데이터센터 내부보다 훨씬 낮은 대역폭을 가지며, 사용 가능한 대역폭 역시 시시각각 변하는 특성을 가지고 있다.
- 뿐만 아니라 지연이 높아지는 만큼 사용 가능한 대역폭을 최대한 활용하는 것 역시 더 어려워진다.

#### 더 높은 비용

- 카프카를 온프레미스에서 운영하든 클라우드에서 운영하든 간에, 클러스터 간의 통신에는 더 많은 비용이 든다.
- 공급자가 서로 다른 데이터센터, 리전, 클라우드와의 데이터 전송에 과금하기 때문이다.


카프카 클러스터 아키텍처를 구성할 떄, 아래의 원칙을 참고하자

1. 하나의 데이터센터 당 한 개 이상의 클러스터를 설치한다.
- 카프카의 브로커와 클라이언트는 하나의 데이터센터 안에서 실행되도록 설계, 개발, 테스트되어 있다.
- 개발자들은 브로커와 클라이언트 사이에 낮은 지연, 높은 대역폭을 가진 상황을 상정하며, 타임아웃 기본값이나 버퍼 크기 또한 이에 맞춰 설정되어 있다.
- 따라서 카프카 브로커를 다른 데이터센터에 나눠서 설치하는 것은 권장되지 않는다.

2. 각각의 데이터센터 간에 각각의 이벤트를 (에러로 인한 재시도를 제외하면) 정확히 한 번씩 복제한다.

3. 가능하다면, 원격 데이터센터에 쓰는 것보다 원격 데이터센터에서 읽어오는게 낫다.
- 원격 데이터센터에 쓰는 작업을 하는 경우, 더 높은 통신 지연과 네트워크 에러 발생 가능성을 감수해야 하기 때문이다.

#### 10.2.2 허브-앤-스포크 아키텍처











